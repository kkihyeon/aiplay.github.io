<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI í”½ì…€ ì‚¬ì§„ê¸°</title>
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬: p5.js(ê·¸ë˜í”½), ml5.js(AI), Tailwind CSS(UI ë ˆì´ì•„ì›ƒ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.6.0/dist/ml5.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            background-color: #f8fafc; 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; padding: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ìº”ë²„ìŠ¤ ì˜ì—­ ê³µí†µ ìŠ¤íƒ€ì¼: ê³ ì •ëœ max-widthë¥¼ ì œê±°í•˜ê³  ë¶€ëª¨ ë„ˆë¹„ì— ë§ì¶¤ */
        #canvas-pixel, #canvas-ai {
            touch-action: none; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            background: #fff;
            line-height: 0;
            position: relative;
            width: 100%;
            margin: 0 auto;
        }

        /* ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ ë° ìŠ¤íƒ€ì¼ */
        .mode-btn { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid #e2e8f0; background: white; }
        .mode-btn.active { 
            background-color: #4f46e5; 
            color: white; 
            border-color: #4338ca;
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
            transform: translateY(-2px);
        }

        /* íŒ”ë ˆíŠ¸ ìƒ‰ìƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .color-dot { width: 44px; height: 44px; border-radius: 10px; cursor: pointer; border: 3px solid transparent; flex-shrink: 0; }
        .color-dot.selected { border-color: #0f172a; transform: scale(1.1); }
        
        /* ìº”ë²„ìŠ¤ê°€ ë¶€ëª¨ ì˜ì—­ì„ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì • */
        canvas { display: block; width: 100% !important; height: auto !important; }
        
        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="p-3 md:p-6 pb-20">
    <!-- AI í™”ê°€ ë¡œë”© í™”ë©´ -->
    <div id="loading-overlay">
        <div class="w-14 h-14 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
        <p class="font-black text-slate-800 text-xl tracking-tight">AI í™”ê°€ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</p>
        <p class="text-slate-400 text-sm mt-3">ë‚˜ë§Œì˜ ë§ˆìŠ¤í¬ë¥¼ ê·¸ë ¤ë³´ì„¸ìš”!</p>
    </div>

    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ: PCì—ì„œëŠ” ë„“ê²Œ(6xl), ëª¨ë°”ì¼ì—ì„œëŠ” ì¢ê²Œ ìë™ìœ¼ë¡œ ì¡°ì ˆë¨ -->
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8 pt-4">
            <h1 class="text-3xl font-black text-slate-900 mb-1 tracking-tighter italic">ğŸ¨ AI PIXEL CAM v3</h1>
            <p class="text-slate-500 font-semibold italic text-sm">ë©‹ì§„ ë§ˆìŠ¤í¬ë¥¼ ë§Œë“¤ì–´ë´ìš”!</p>
        </header>

        <!-- ëª¨ë“œ ì„ íƒ ë²„íŠ¼ ì˜ì—­ -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex bg-white p-2 rounded-2xl shadow-md border border-slate-100">
                <button id="mode-headband" class="mode-btn active px-8 py-3 rounded-xl font-black text-lg">ğŸ‘‘ ë¨¸ë¦¬ë </button>
                <button id="mode-mask" class="mode-btn px-8 py-3 rounded-xl font-black text-lg ml-2">ğŸ­ ë§ˆìŠ¤í¬</button>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­: PC(lg) ì´ìƒì—ì„œëŠ” 2ì—´ ê·¸ë¦¬ë“œë¡œ ë‚˜ë€íˆ ë°°ì¹˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-start">
            
            <!-- 1. ìƒë‹¨ ê·¸ë¦¼íŒ ì˜ì—­ -->
            <div class="flex flex-col items-center w-full">
                <div class="w-full flex justify-between items-center mb-4 px-2">
                    <span class="text-xs font-black text-white bg-indigo-500 px-3 py-1.5 rounded-full shadow-sm uppercase tracking-wide">Step 1. Design Board</span>
                    <button id="clear-btn" class="text-xs font-bold text-red-500 bg-red-50 px-4 py-2 rounded-xl active:bg-red-100 hover:bg-red-100 transition">ëª¨ë‘ ì§€ìš°ê¸°</button>
                </div>
                <div id="canvas-pixel" class="w-full"></div>
                
                <!-- íŒ”ë ˆíŠ¸ ë° ë„êµ¬ ì œì–´ ì˜ì—­ -->
                <div class="w-full mt-6 bg-white p-6 rounded-[2.5rem] shadow-2xl border border-slate-50">
                    <div class="flex overflow-x-auto gap-3 pb-5 mb-5" id="palette" style="-webkit-overflow-scrolling: touch;">
                        <!-- JSì—ì„œ ìƒ‰ìƒ ë²„íŠ¼ë“¤ì´ ì£¼ì…ë¨ -->
                    </div>
                    <div class="flex gap-4">
                        <button id="eraser-btn" class="flex-1 py-5 bg-slate-50 text-slate-600 rounded-2xl font-black text-xl border-2 border-slate-100 active:bg-slate-200 shadow-sm transition">ğŸ§½ ì§€ìš°ê°œ</button>
                        <button id="capture-btn" class="flex-[1.5] py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-xl shadow-indigo-100 active:scale-95 transition-transform">ğŸ“¸ ì‚¬ì§„ ì°ê¸°</button>
                    </div>
                </div>
            </div>

            <!-- 2. AI ì¹´ë©”ë¼ ì˜ì—­ -->
            <div class="flex flex-col items-center w-full">
                <div class="w-full flex justify-between items-center mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <div id="status-dot" class="w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
                        <span id="status-msg" class="text-sm font-black text-orange-600 tracking-tight uppercase">AI Tracking...</span>
                    </div>
                    <span class="text-xs font-bold text-slate-300 italic uppercase">Preview Mode</span>
                </div>
                <div id="canvas-ai" class="w-full"></div>
                
                <!-- í•˜ë‹¨ ê°€ì´ë“œ í…ìŠ¤íŠ¸ -->
                <div class="mt-8 p-6 bg-white rounded-[2rem] border-l-[10px] border-indigo-500 shadow-sm w-full">
                    <h5 class="font-black text-slate-800 mb-2 italic">âœ¨ Real-time Magic</h5>
                    <p class="text-slate-600 text-sm leading-relaxed">
                        í™”ë©´ì˜ <b>ì¹´ë©”ë¼</b>ë¥¼ ë³´ë©° ìœ„ì¹˜ë¥¼ ë§ì¶°ë³´ì„¸ìš”! <br>
                        ê·¸ë¦¼íŒì˜ ê°€ì´ë“œì— ë§ì¶° ê·¸ë¦¬ë©´ ì–¼êµ´ ë¶€ìœ„ì— ë” ì •í™•í•˜ê²Œ ë°˜ì˜ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ì „ì—­ ì„¤ì • ë³€ìˆ˜
         * gridSize: 64x64 ê³ í•´ìƒë„ ê·¸ë¦¬ë“œ ì„¤ì •
         */
        const gridSize = 64; 
        let pixelGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
        let currentColor = '#4F46E5';
        let isEraser = false;
        let currentMode = 'headband'; 

        const colors = ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#A855F7', '#EC4899', '#000000', '#FFFFFF'];
        const paletteDiv = document.getElementById('palette');
        const eraserBtn = document.getElementById('eraser-btn');

        // íŒ”ë ˆíŠ¸ ìƒ‰ìƒ ë²„íŠ¼ ìë™ ìƒì„± ë¡œì§
        colors.forEach(c => {
            const div = document.createElement('div');
            div.className = `color-dot ${c === '#4F46E5' ? 'selected' : ''}`;
            div.style.backgroundColor = c;
            div.onclick = () => {
                currentColor = c; isEraser = false;
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                div.classList.add('selected');
                eraserBtn.classList.remove('bg-indigo-100', 'border-indigo-300');
            };
            paletteDiv.appendChild(div);
        });

        // ì§€ìš°ê°œ ëª¨ë“œ ì „í™˜ ê¸°ëŠ¥
        eraserBtn.onclick = () => {
            isEraser = true;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            eraserBtn.classList.add('bg-indigo-100', 'border-indigo-300');
        };

        // ë¨¸ë¦¬ë /ë§ˆìŠ¤í¬ ëª¨ë“œ ì „í™˜ ê¸°ëŠ¥
        const setMode = (mode) => {
            currentMode = mode;
            document.getElementById('mode-headband').classList.toggle('active', mode === 'headband');
            document.getElementById('mode-mask').classList.toggle('active', mode === 'mask');
        };
        document.getElementById('mode-headband').onclick = () => setMode('headband');
        document.getElementById('mode-mask').onclick = () => setMode('mask');

        /**
         * 1. ìƒë‹¨ ê·¸ë¦¼íŒ ì˜ì—­ (p5.js ì¸ìŠ¤í„´ìŠ¤)
         * ê¸°ê¸°ë³„ ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ìº”ë²„ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         */
        const pixelSketch = (p) => {
            let cellSize;
            p.setup = () => {
                // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ(#canvas-pixel)ì˜ ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                let canvasContainer = document.getElementById('canvas-pixel');
                let w = canvasContainer.offsetWidth;
                cellSize = w / gridSize; 
                p.createCanvas(w, w);
            };

            p.draw = () => {
                p.background(255);
                p.drawGuide(); // ì–¼êµ´ ìœ„ì¹˜ë¥¼ ê°€ëŠ í•  ìˆ˜ ìˆëŠ” íšŒìƒ‰ ê°€ì´ë“œ ë¼ì¸ ê·¸ë¦¬ê¸°
                
                // ê·¸ë¦¬ë“œ ë°°ê²½ ê²©ì ì„  ê·¸ë¦¬ê¸°
                p.stroke(242); p.strokeWeight(0.5);
                for(let i=0; i<=gridSize; i++) {
                    p.line(i*cellSize, 0, i*cellSize, p.height);
                    p.line(0, i*cellSize, p.width, i*cellSize);
                }

                // pixelGrid ë°°ì—´ì˜ ë°ì´í„°ë¥¼ í™”ë©´ì— ë Œë”ë§
                for(let x=0; x<gridSize; x++) {
                    for(let y=0; y<gridSize; y++) {
                        if(pixelGrid[x][y]) {
                            p.noStroke(); p.fill(pixelGrid[x][y]);
                            p.rect(x*cellSize, y*cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì…ë ¥ ì²˜ë¦¬: ìº”ë²„ìŠ¤ ì˜ì—­ ë‚´ì—ì„œë§Œ ì‘ë™
                if (p.mouseIsPressed && p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
                    let x = Math.floor(p.mouseX / cellSize);
                    let y = Math.floor(p.mouseY / cellSize);
                    if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) {
                        pixelGrid[x][y] = isEraser ? null : currentColor;
                    }
                }
            };

            // ë””ìì¸ ê°€ì´ë“œë¼ì¸ ê·¸ë¦¬ê¸° (64 ê·¸ë¦¬ë“œ ê¸°ì¤€)
            p.drawGuide = () => {
                p.noStroke(); p.fill(248);
                if (currentMode === 'headband') {
                    p.rect(12*cellSize, 52*cellSize, 16*cellSize, 3*cellSize, 6);
                    p.rect(36*cellSize, 52*cellSize, 16*cellSize, 3*cellSize, 6);
                    p.arc(32*cellSize, 72*cellSize, 56*cellSize, 40*cellSize, p.PI, p.TWO_PI);
                } else {
                    p.ellipse(22*cellSize, 21*cellSize, 12*cellSize, 8*cellSize);
                    p.ellipse(42*cellSize, 21*cellSize, 12*cellSize, 8*cellSize);
                    p.rect(28*cellSize, 22*cellSize, 8*cellSize, 12*cellSize, 10);
                    p.ellipse(32*cellSize, 39*cellSize, 20*cellSize, 10*cellSize);
                }
            };

            // ë¸Œë¼ìš°ì € í¬ê¸°ê°€ ë°”ë€” ë•Œ ìº”ë²„ìŠ¤ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            p.windowResized = () => {
                let w = document.getElementById('canvas-pixel').offsetWidth;
                p.resizeCanvas(w, w);
                cellSize = w / gridSize;
            };

            document.getElementById('clear-btn').onclick = () => {
                pixelGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
            };
        };
        new p5(pixelSketch, 'canvas-pixel');

        /**
         * 2. í•˜ë‹¨ AI ì¹´ë©”ë¼ ì˜ì—­ (p5.js + ml5.js ì¸ìŠ¤í„´ìŠ¤)
         * ì‹¤ì‹œê°„ ì–¼êµ´ ì¸ì‹ì„ í†µí•´ í”½ì…€ ì•„íŠ¸ë¥¼ íˆ¬ì˜í•©ë‹ˆë‹¤.
         */
        const aiSketch = (p) => {
            let video; let faceMesh; let predictions = [];
            let vScale = 1; let offX = 0; let offY = 0;

            p.setup = () => {
                let w = document.getElementById('canvas-ai').offsetWidth;
                p.createCanvas(w, w);

                const constraints = {
                    video: { facingMode: "user" }, // ì…€í”¼ ì¹´ë©”ë¼ ì‚¬ìš©
                    audio: false
                };

                video = p.createCapture(constraints);
                video.elt.setAttribute('playsinline', ''); 
                video.elt.muted = true;
                video.hide();

                // ML5 Facemesh ì´ˆê¸°í™” ë° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                faceMesh = ml5.facemesh(video, () => {
                    document.getElementById('status-msg').innerText = "LIVE ì¸ì‹ ì¤‘";
                    document.getElementById('status-msg').classList.replace('text-orange-600', 'text-green-600');
                    document.getElementById('status-dot').classList.replace('bg-orange-500', 'bg-green-500');
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 500);
                });
                faceMesh.on("predict", r => predictions = r);
            };

            p.draw = () => {
                if (video.elt.readyState < 2) return;

                // ë¹„ë””ì˜¤ë¥¼ ìº”ë²„ìŠ¤ì— ê½‰ ì±„ìš°ê¸° ìœ„í•œ ìŠ¤ì¼€ì¼ë§/ì˜¤í”„ì…‹ ê³„ì‚° (Center Crop ë¡œì§)
                let vW = video.width;
                let vH = video.height;
                vScale = Math.max(p.width / vW, p.height / vH);
                let rW = vW * vScale;
                let rH = vH * vScale;
                offX = (p.width - rW) / 2;
                offY = (p.height - rH) / 2;

                // 1ë‹¨ê³„: ê±°ìš¸ ëª¨ë“œë¡œ ë°°ê²½ ë¹„ë””ì˜¤ ê·¸ë¦¬ê¸°
                p.push();
                p.translate(p.width, 0);
                p.scale(-1, 1);
                p.image(video, offX, offY, rW, rH);
                p.pop();

                // 2ë‹¨ê³„: ì–¼êµ´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë””ìì¸ íˆ¬ì˜
                if (predictions.length > 0) {
                    predictions.forEach(face => {
                        let scaledMesh = face.scaledMesh;
                        // ê¸°ì¤€ì  ì„ ì • (ì´ë§ˆ ì¤‘ì•™ ë˜ëŠ” ë¯¸ê°„)
                        let target = (currentMode === 'headband') ? scaledMesh[10] : scaledMesh[168];
                        
                        // ì–¼êµ´ ë„ˆë¹„ ê³„ì‚° (ìŠ¤ì¼€ì¼ ì¡°ì ˆìš©)
                        let leftPoint = scaledMesh[234];
                        let rightPoint = scaledMesh[454];
                        let faceDist = p.dist(leftPoint[0], leftPoint[1], rightPoint[0], rightPoint[1]);
                        
                        // ê±°ìš¸ ë°˜ì „ ì¢Œí‘œ ë³´ì • ê³„ì‚°
                        let mappedX = target[0] * vScale + offX;
                        let drawX = p.width - mappedX;
                        let drawY = target[1] * vScale + offY;

                        p.push();
                        p.translate(drawX, drawY);
                        
                        // ì–¼êµ´ ê±°ë¦¬ì— ë”°ë¼ í”½ì…€ ë””ìì¸ í¬ê¸° ë¹„ë¡€ ì¡°ì ˆ
                        let maskScale = (faceDist * vScale) / p.width * 1.6;
                        p.scale(maskScale);

                        // ë””ìì¸ ì¢…ë¥˜ì— ë”°ë¥¸ ë¶€ì°© ìœ„ì¹˜ ë¯¸ì„¸ ì¡°ì •
                        let centerOff = p.width / 2;
                        if(currentMode === 'headband') {
                            p.translate(-centerOff, -p.width * 0.95);
                        } else {
                            p.translate(-centerOff, -p.width * 0.29);
                        }

                        // 64x64 ê·¸ë¦¬ë“œ ê¸°ë°˜ í”½ì…€ ê·¸ë¦¬ê¸°
                        let dCell = p.width / gridSize;
                        for(let x=0; x<gridSize; x++) {
                            for(let y=0; y<gridSize; y++) {
                                if(pixelGrid[x][y]) {
                                    p.noStroke(); p.fill(pixelGrid[x][y]);
                                    p.rect(x*dCell, y*dCell, dCell, dCell);
                                }
                            }
                        }
                        p.pop();
                    });
                }
            };

            // ì°½ í¬ê¸° ì¡°ì ˆ ì‹œ ì¹´ë©”ë¼ ìº”ë²„ìŠ¤ ëŒ€ì‘
            p.windowResized = () => {
                let w = document.getElementById('canvas-ai').offsetWidth;
                p.resizeCanvas(w, w);
            };

            // ê²°ê³¼ë¬¼ ì €ì¥ ê¸°ëŠ¥
            document.getElementById('capture-btn').onclick = () => {
                p.saveCanvas('my_ai_pixel_art_v3', 'png');
            };
        };
        new p5(aiSketch, 'canvas-ai');
    </script>
</body>
</html>
