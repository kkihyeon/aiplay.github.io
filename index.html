<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI í”½ì…€ ì‚¬ì§„ê¸° - ëª¨ë°”ì¼ ëŒ€ì‘ ë²„ì „</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.6.0/dist/ml5.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { background-color: #f8fafc; font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        #canvas-pixel, #canvas-ai { touch-action: none; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: #fff; line-height: 0; width: 100% !important; height: auto !important; }
        .mode-btn { transition: all 0.25s ease; border: 2px solid #e2e8f0; background: white; }
        .mode-btn.active { background-color: #4f46e5; color: white; border-color: #4338ca; box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3); }
        .color-dot { width: 44px; height: 44px; border-radius: 10px; cursor: pointer; border: 3px solid transparent; flex-shrink: 0; }
        .color-dot.selected { border-color: #0f172a; transform: scale(1.1); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s ease; }
    </style>
</head>
<body class="p-4 pb-20">
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-black text-slate-800 text-lg">ì¹´ë©”ë¼ì™€ AIë¥¼ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...</p>
        <p class="text-slate-400 text-sm mt-2 text-center px-6">ëª¨ë°”ì¼ì€ ë¡œë”©ì— ìµœëŒ€ 10ì´ˆê°€ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div class="max-w-xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl font-black text-slate-900 mb-1">ğŸ¨ AI í”½ì…€ ì‚¬ì§„ê¸°</h1>
            <p class="text-slate-500 font-semibold text-xs italic">ê·¸ë¦¼ì€ ë˜‘ë°”ë¡œ, ê±°ìš¸ë§Œ ë°˜ì „!</p>
        </header>

        <div class="flex justify-center mb-6">
            <div class="inline-flex bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                <button id="mode-headband" class="mode-btn active px-6 py-2 rounded-xl font-black text-base">ğŸ‘‘ ë¨¸ë¦¬ë </button>
                <button id="mode-mask" class="mode-btn px-6 py-2 rounded-xl font-black text-base ml-1">ğŸ­ ë§ˆìŠ¤í¬</button>
            </div>
        </div>

        <div class="space-y-8">
            <div class="flex flex-col items-center">
                <div class="w-full flex justify-between items-center mb-3 px-2">
                    <span class="text-xs font-black text-white bg-indigo-500 px-3 py-1 rounded-full uppercase">1. ê·¸ë¦¼íŒ</span>
                    <button id="clear-btn" class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1 rounded-lg">ì´ˆê¸°í™”</button>
                </div>
                <div id="canvas-pixel"></div>
                <div class="w-full mt-4 bg-white p-4 rounded-[2rem] shadow-lg border border-slate-100">
                    <div class="flex overflow-x-auto gap-2 pb-3 mb-3" id="palette"></div>
                    <div class="flex gap-2">
                        <button id="eraser-btn" class="flex-1 py-3 bg-slate-50 text-slate-600 rounded-xl font-black text-lg border-2 border-slate-100">ğŸ§½ ì§€ìš°ê°œ</button>
                        <button id="capture-btn" class="flex-[1.5] py-3 bg-indigo-600 text-white rounded-xl font-black text-lg">ğŸ“¸ ì‚¬ì§„ ì°ê¸°</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <div class="w-full flex justify-between items-center mb-3 px-2">
                    <div class="flex items-center gap-2">
                        <div id="status-dot" class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                        <span id="status-msg" class="text-xs font-black text-orange-600 tracking-tighter">AI ë¶„ì„ ëŒ€ê¸° ì¤‘...</span>
                    </div>
                </div>
                <div id="canvas-ai"></div>
            </div>
        </div>
    </div>

    <script>
        const gridSize = 32;
        let cellSize = 10;
        let pixelGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
        let currentColor = '#4F46E5';
        let isEraser = false;
        let currentMode = 'headband';

        const colors = ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#A855F7', '#EC4899', '#000000', '#FFFFFF'];
        const paletteDiv = document.getElementById('palette');
        const eraserBtn = document.getElementById('eraser-btn');

        colors.forEach(c => {
            const div = document.createElement('div');
            div.className = `color-dot ${c === '#4F46E5' ? 'selected' : ''}`;
            div.style.backgroundColor = c;
            div.onclick = () => {
                currentColor = c; isEraser = false;
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                div.classList.add('selected');
                eraserBtn.classList.remove('bg-indigo-100', 'border-indigo-300');
            };
            paletteDiv.appendChild(div);
        });

        eraserBtn.onclick = () => {
            isEraser = true;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            eraserBtn.classList.add('bg-indigo-100', 'border-indigo-300');
        };

        const setMode = (mode) => {
            currentMode = mode;
            document.getElementById('mode-headband').classList.toggle('active', mode === 'headband');
            document.getElementById('mode-mask').classList.toggle('active', mode === 'mask');
        };
        document.getElementById('mode-headband').onclick = () => setMode('headband');
        document.getElementById('mode-mask').onclick = () => setMode('mask');

        const pixelSketch = (p) => {
            p.setup = () => {
                let w = Math.min(window.innerWidth - 32, 400);
                cellSize = w / gridSize;
                p.createCanvas(gridSize * cellSize, gridSize * cellSize);
            };
            p.draw = () => {
                p.background(255);
                p.noStroke(); p.fill(248);
                if (currentMode === 'headband') {
                    p.rect(6*cellSize, 26*cellSize, 8*cellSize, 1.5*cellSize, 6);
                    p.rect(18*cellSize, 26*cellSize, 8*cellSize, 1.5*cellSize, 6);
                    p.arc(16*cellSize, 36*cellSize, 28*cellSize, 20*cellSize, p.PI, p.TWO_PI);
                } else {
                    p.ellipse(10*cellSize, 15*cellSize, 6*cellSize, 4*cellSize);
                    p.ellipse(22*cellSize, 15*cellSize, 6*cellSize, 4*cellSize);
                    p.rect(14*cellSize, 17*cellSize, 4*cellSize, 6*cellSize, 10);
                    p.ellipse(16*cellSize, 27*cellSize, 10*cellSize, 5*cellSize);
                }
                p.stroke(242); p.strokeWeight(0.5);
                for(let i=0; i<=gridSize; i++) {
                    p.line(i*cellSize, 0, i*cellSize, p.height);
                    p.line(0, i*cellSize, p.width, i*cellSize);
                }
                for(let x=0; x<gridSize; x++) {
                    for(let y=0; y<gridSize; y++) {
                        if(pixelGrid[x][y]) {
                            p.noStroke(); p.fill(pixelGrid[x][y]);
                            p.rect(x*cellSize, y*cellSize, cellSize, cellSize);
                        }
                    }
                }
                if (p.mouseIsPressed && p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
                    let x = Math.floor(p.mouseX / cellSize);
                    let y = Math.floor(p.mouseY / cellSize);
                    if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) {
                        pixelGrid[x][y] = isEraser ? null : currentColor;
                    }
                }
            };
            document.getElementById('clear-btn').onclick = () => pixelGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
        };
        new p5(pixelSketch, 'canvas-pixel');

        const aiSketch = (p) => {
            let video; let faceMesh; let predictions = [];
            let videoLoaded = false;

            p.setup = () => {
                let w = Math.min(window.innerWidth - 32, 400);
                p.createCanvas(w, w * (4/3)); // ëª¨ë°”ì¼ í‘œì¤€ 4:3 ë¹„ìœ¨ë¡œ ê°•ì œ ì„¤ì •
                
                const constraints = {
                    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                };

                video = p.createCapture(constraints, (stream) => {
                    videoLoaded = true;
                    // ìë™ì¬ìƒ ê°•ì œ
                    video.elt.play().catch(e => console.log("Auto-play blocked"));
                });
                video.size(640, 480);
                video.elt.setAttribute('playsinline', '');
                video.elt.muted = true;
                video.hide();

                faceMesh = ml5.facemesh(video, () => {
                    document.getElementById('status-msg').innerText = "âœ… ì¸ì‹ ì¤‘";
                    document.getElementById('status-msg').className = "text-xs font-black text-green-600";
                    document.getElementById('status-dot').className = "w-2 h-2 bg-green-500 rounded-full";
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                });
                faceMesh.on("predict", r => predictions = r);
            };

            p.draw = () => {
                p.background(240);
                if (!videoLoaded) return;

                // 1. ì¹´ë©”ë¼ ë°˜ì „ ê·¸ë¦¬ê¸° (ì°Œê·¸ëŸ¬ì§ ë°©ì§€ ë¡œì§)
                p.push();
                p.translate(p.width, 0);
                p.scale(-1, 1);
                
                // ë¹„ë””ì˜¤ ë¹„ìœ¨ì„ ìº”ë²„ìŠ¤ì— ë§ì¶° ê³„ì‚°
                let vW = video.elt.videoWidth || 640;
                let vH = video.elt.videoHeight || 480;
                let vAspect = vW / vH;
                let cAspect = p.width / p.height;
                
                let renderW, renderH, offsetRow = 0, offsetCol = 0;
                if (vAspect > cAspect) {
                    renderH = p.height;
                    renderW = p.height * vAspect;
                    offsetCol = (renderW - p.width) / 2;
                } else {
                    renderW = p.width;
                    renderH = p.width / vAspect;
                    offsetRow = (renderH - p.height) / 2;
                }
                
                p.image(video, -offsetCol, -offsetRow, renderW, renderH);
                p.pop();

                // 2. ë§ˆìŠ¤í¬ íˆ¬ì˜ (ì¢Œí‘œ ì¬ë§¤í•‘)
                if (predictions.length > 0) {
                    predictions.forEach((prediction) => {
                        let scaledMesh = prediction.scaledMesh;
                        let target = (currentMode === 'headband') ? scaledMesh[10] : scaledMesh[168];
                        let left = scaledMesh[234], right = scaledMesh[454];
                        let fWidth = p.dist(left[0], left[1], right[0], right[1]);
                        
                        // ë¹„ë””ì˜¤ ì›ë³¸ ì¢Œí‘œ -> ìº”ë²„ìŠ¤ ë Œë”ë§ ì¢Œí‘œë¡œì˜ ìŠ¤ì¼€ì¼ ê³„ì‚°
                        let sX = renderW / vW;
                        let sY = renderH / vH;

                        p.push();
                        // ìº”ë²„ìŠ¤ ë°˜ì „ ìƒíƒœì´ë¯€ë¡œ Xì¢Œí‘œ ê±°ìš¸ìƒ ë³€í™˜
                        let drawX = p.width - (target[0] * sX - offsetCol);
                        let drawY = target[1] * sY - offsetRow;
                        
                        p.translate(drawX, drawY);
                        let s = (fWidth * sX) / (gridSize * cellSize) * 1.55;
                        p.scale(s);
                        
                        if(currentMode === 'headband') p.translate(-(gridSize * cellSize)/2, -(gridSize * cellSize) * 0.92);
                        else p.translate(-(gridSize * cellSize)/2, -(gridSize * cellSize) * 0.47);

                        for(let x=0; x<gridSize; x++) {
                            for(let y=0; y<gridSize; y++) {
                                if(pixelGrid[x][y]) {
                                    p.noStroke(); p.fill(pixelGrid[x][y]);
                                    p.rect(x*cellSize, y*cellSize, cellSize, cellSize);
                                }
                            }
                        }
                        p.pop();
                    });
                }
            };
            document.getElementById('capture-btn').onclick = () => p.saveCanvas('ai_photo', 'png');
        };
        new p5(aiSketch, 'canvas-ai');
    </script>
</body>
</html>
