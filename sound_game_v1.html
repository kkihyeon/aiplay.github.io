<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì´ìŠ¤ ì í”„ ë ˆíŠ¸ë¡œ ê²Œì„</title>
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬: p5.js(ê·¸ë˜í”½), p5.sound.js(ìŒí–¥ ì¸ì‹), Tailwind CSS(ë””ìì¸) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            background-color: #0f172a; 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; padding: 0;
            overflow: hidden; /* ê²Œì„ í™”ë©´ ë°– ìŠ¤í¬ë¡¤ ë°©ì§€ */
            color: white;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ê²Œì„ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
        canvas {
            border: 4px solid #334155;
            border-radius: 1rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- ìƒë‹¨ ì •ë³´ UI -->
        <div class="mb-4 text-center">
            <h1 class="text-3xl font-black tracking-tighter text-indigo-400 mb-1 italic">ğŸ® VOICE JUMP RETRO</h1>
            <p class="text-slate-400 text-sm">ì†Œë¦¬ë¥¼ ì§ˆëŸ¬ì„œ ì¥ì• ë¬¼ì„ ë„˜ìœ¼ì„¸ìš”!</p>
        </div>

        <!-- ê²Œì„ í™”ë©´ì´ ë“¤ì–´ê°ˆ ê³³ -->
        <div id="canvas-holder"></div>

        <!-- í•˜ë‹¨ ì œì–´ ë° ìƒíƒœ UI -->
        <div class="mt-6 w-full max-w-md bg-slate-800/50 p-6 rounded-3xl border border-slate-700 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div id="mic-dot" class="w-3 h-3 bg-red-500 rounded-full"></div>
                    <span id="mic-status" class="text-xs font-bold text-slate-300 uppercase">ë§ˆì´í¬ êº¼ì§</span>
                </div>
                <span id="score-display" class="text-xl font-black text-yellow-400">SCORE: 0</span>
            </div>
            
            <!-- ë§ˆì´í¬ ê°ë„ ì¡°ì ˆ ìŠ¬ë¼ì´ë” -->
            <div class="space-y-2">
                <div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase">
                    <span>ë§ˆì´í¬ ê°ë„</span>
                    <span id="sensitivity-value">5.0</span>
                </div>
                <input type="range" id="sensitivity-slider" min="1" max="10" step="0.1" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
            </div>

            <button id="start-btn" class="w-full mt-6 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-black text-xl rounded-2xl shadow-lg transition-all active:scale-95">
                ê²Œì„ ì‹œì‘í•˜ê¸°
            </button>
        </div>
    </div>

    <script>
        /**
         * ê²Œì„ ìƒìˆ˜ ë° ë³€ìˆ˜ ì„¤ì •
         */
        let bird;           // í”Œë ˆì´ì–´ ìºë¦­í„°
        let pipes = [];     // ì¥ì• ë¬¼ ë°°ì—´
        let mic;            // ë§ˆì´í¬ ì…ë ¥ ê°ì²´
        let isPlaying = false; // ê²Œì„ ì§„í–‰ ìƒíƒœ (ë¬¼ë¦¬ ì—”ì§„ í™œì„±í™” ì—¬ë¶€)
        let isCountingDown = false; // ì¹´ìš´íŠ¸ë‹¤ìš´ ìƒíƒœ ì—¬ë¶€
        let countdownValue = "";    // í™”ë©´ì— í‘œì‹œë  ì¹´ìš´íŠ¸ë‹¤ìš´ í…ìŠ¤íŠ¸ (3, 2, 1, GO!)
        let score = 0;      // í˜„ì¬ ì ìˆ˜
        let sensitivity = 5; // ë§ˆì´í¬ ê°ë„
        let gameCanvas;     // ìº”ë²„ìŠ¤ ê°ì²´

        /**
         * p5.js ì´ˆê¸° ì„¤ì •
         */
        function setup() {
            // ë°˜ì‘í˜• ìº”ë²„ìŠ¤ í¬ê¸° ê²°ì •
            let w = Math.min(window.innerWidth - 40, 400);
            let h = Math.min(window.innerHeight * 0.5, 500);
            
            gameCanvas = createCanvas(w, h);
            gameCanvas.parent('canvas-holder');
            
            // ë§ˆì´í¬ ì…ë ¥ ì´ˆê¸°í™”
            mic = new p5.AudioIn();
            
            // ì´ˆê¸° ìºë¦­í„° ìƒì„±
            bird = new Bird();
            
            // í”„ë ˆì„ë ˆì´íŠ¸ ê³ ì •
            frameRate(60);
        }

        /**
         * ë©”ì¸ ê²Œì„ ë£¨í”„
         */
        function draw() {
            // ë°°ê²½ ê·¸ë¦¬ê¸° (ì–¸ì œë‚˜ ê·¸ë ¤ì§)
            background(15, 23, 42);

            // 1. ì´ˆê¸° ëŒ€ê¸° ìƒíƒœ (ì‹œì‘ ì „)
            if (!isPlaying && !isCountingDown) {
                drawStartScreen();
                return;
            }

            // 2. ì¹´ìš´íŠ¸ë‹¤ìš´ ìˆ«ì(3, 2, 1)ì¼ ë•ŒëŠ” ê²€ì€ ë°°ê²½ì— ìˆ«ìë§Œ í‘œì‹œ
            if (isCountingDown && countdownValue !== "GO!" && !isPlaying) {
                drawCountdown();
                return;
            }

            // 3. "GO!" ë‹¨ê³„ì´ê±°ë‚˜ ì‹¤ì œ ê²Œì„ ì§„í–‰(isPlaying) ì¤‘ì¼ ë•Œ ê²Œì„ í™”ë©´ í‘œì‹œ
            if (isPlaying || (isCountingDown && countdownValue === "GO!")) {
                
                // ë§ˆì´í¬ ë³¼ë¥¨ ê°€ì ¸ì˜¤ê¸°
                let vol = mic.getLevel(); 

                // ì‹¤ì œ ê²Œì„ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸(update)í•¨
                if (isPlaying) {
                    bird.update(vol);
                    
                    // ì¥ì• ë¬¼ ìƒì„± (100í”„ë ˆì„ë§ˆë‹¤)
                    if (frameCount % 100 == 0) {
                        pipes.push(new Pipe());
                    }
                }

                // ìºë¦­í„°ëŠ” í•­ìƒ ê·¸ë¦¼ (GO! ì¼ ë•ŒëŠ” ì •ì§€ ìƒíƒœë¡œ ë³´ì„)
                bird.show();

                // ì¥ì• ë¬¼ ê´€ë¦¬
                for (let i = pipes.length - 1; i >= 0; i--) {
                    pipes[i].show();
                    
                    if (isPlaying) {
                        pipes[i].update();

                        // ìºë¦­í„°ì™€ ì¶©ëŒ ì²´í¬
                        if (pipes[i].hits(bird)) {
                            gameOver();
                        }

                        // ì ìˆ˜ ê³„ì‚°
                        if (pipes[i].pass(bird)) {
                            score++;
                            document.getElementById('score-display').innerText = `SCORE: ${score}`;
                        }
                    }

                    // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ì¥ì• ë¬¼ ì œê±°
                    if (pipes[i].offscreen()) {
                        pipes.splice(i, 1);
                    }
                }

                // ë°”ë‹¥/ì²œì¥ ì¶©ëŒ ì²´í¬ (ê²Œì„ ì¤‘ì¼ ë•Œë§Œ)
                if (isPlaying && bird.offScreen()) {
                    gameOver();
                }

                // "GO!" ë¬¸êµ¬ê°€ ì•„ì§ ì‚´ì•„ìˆë‹¤ë©´ ê²Œì„ í™”ë©´ ìœ„ì— ë®ì–´ì”Œì›€
                if (isCountingDown && countdownValue === "GO!") {
                    drawCountdown();
                }
            }
        }

        /**
         * ìºë¦­í„°(í”Œë ˆì´ì–´) í´ë˜ìŠ¤
         */
        class Bird {
            constructor() {
                this.y = height / 2;
                this.x = 64;
                this.gravity = 0.6;   // ì¤‘ë ¥ ê°€ì†ë„
                this.velocity = 0;    // ìˆ˜ì§ ì†ë„
                this.r = 16;          // ìºë¦­í„° ë°˜ì§€ë¦„
            }

            show() {
                noStroke();
                fill(255, 235, 59); // ë…¸ë€ìƒ‰ ë³¸ì²´
                rectMode(CENTER);
                rect(this.x, this.y, this.r * 2, this.r * 2, 4);
                
                fill(0);
                rect(this.x + 8, this.y - 4, 4, 4);
            }

            update(vol) {
                let threshold = 0.02; 
                if (vol > threshold) {
                    let lift = map(vol, threshold, 0.5, 0, -25) * (sensitivity / 5);
                    this.velocity += lift;
                }

                this.velocity += this.gravity; 
                this.velocity *= 0.9;         
                this.y += this.velocity;      
            }

            offScreen() {
                return (this.y > height || this.y < 0);
            }
        }

        /**
         * ì¥ì• ë¬¼(íŒŒì´í”„) í´ë˜ìŠ¤
         */
        class Pipe {
            constructor() {
                this.spacing = 150; 
                this.top = random(height / 6, (3 / 4) * height);
                this.bottom = height - (this.top + this.spacing);
                this.x = width;
                this.w = 50;
                this.speed = 3;
                this.passed = false;
            }

            hits(bird) {
                if (bird.y - bird.r < this.top || bird.y + bird.r > height - this.bottom) {
                    if (bird.x + bird.r > this.x && bird.x - bird.r < this.x + this.w) {
                        return true;
                    }
                }
                return false;
            }

            pass(bird) {
                if (!this.passed && bird.x > this.x + this.w) {
                    this.passed = true;
                    return true;
                }
                return false;
            }

            show() {
                noStroke();
                fill(71, 85, 105); 
                rectMode(CORNER);
                rect(this.x, 0, this.w, this.top, 0, 0, 8, 8);
                rect(this.x, height - this.bottom, this.w, this.bottom, 8, 8, 0, 0);
            }

            update() {
                this.x -= this.speed;
            }

            offscreen() {
                return (this.x < -this.w);
            }
        }

        /**
         * ê²Œì„ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
         */
        function drawStartScreen() {
            textAlign(CENTER);
            noStroke();
            fill(255);
            textSize(20);
            text("READY?", width / 2, height / 2 - 20);
            textSize(12);
            fill(148, 163, 184);
            text("ì•„ë˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ê³ ", width / 2, height / 2 + 10);
            text("ë§ˆì´í¬ì— ì†Œë¦¬ë¥¼ ë‚´ë³´ì„¸ìš”!", width / 2, height / 2 + 30);
            
            if (mic && mic.enabled) {
                let v = mic.getLevel();
                fill(79, 70, 229, 100);
                rect(width/2 - 50, height - 20, 100, 10);
                fill(79, 70, 229);
                rect(width/2 - 50, height - 20, v * 500, 10);
            }
        }

        function drawCountdown() {
            textAlign(CENTER, CENTER);
            noStroke();
            
            if (countdownValue === "GO!") {
                fill(34, 197, 94); // ì´ˆë¡ìƒ‰
                textSize(80);
                stroke(255);
                strokeWeight(6);
            } else {
                fill(255);
                noStroke();
                textSize(100);
            }
            
            text(countdownValue, width / 2, height / 2);
        }

        /**
         * ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘ ë¹„ë™ê¸° ë¡œì§
         */
        async function startCountdown() {
            isCountingDown = true;
            isPlaying = false;
            
            // 3, 2, 1 ì¹´ìš´íŠ¸ë‹¤ìš´
            for (let i = 3; i > 0; i--) {
                countdownValue = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // "GO!" í‘œì‹œ - ì´ ìˆœê°„ draw()ì—ì„œ ê²Œì„ í™”ë©´ì´ ë’¤ì— ë‚˜íƒ€ë‚¨ (ì •ì§€ ìƒíƒœ)
            countdownValue = "GO!";
            
            // 0.8ì´ˆ ë™ì•ˆ "GO!" ë¬¸êµ¬ë¥¼ ë³´ì—¬ì¤€ ë’¤ ê²Œì„ ë¬¼ë¦¬ ì—”ì§„ ì‹œì‘
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // "GO!"ê°€ ì‚¬ë¼ì§€ë©° ê²Œì„ ì‹œì‘
            isCountingDown = false;
            isPlaying = true;
            frameCount = 0; // ì¥ì• ë¬¼ ìƒì„± íƒ€ì´ë° ì´ˆê¸°í™”
        }

        function gameOver() {
            isPlaying = false;
            isCountingDown = false;
            document.getElementById('start-btn').innerText = "ë‹¤ì‹œ ë„ì „í•˜ê¸°";
            document.getElementById('start-btn').classList.replace('bg-indigo-600', 'bg-red-600');
            pipes = [];
            bird = new Bird();
        }

        const startBtn = document.getElementById('start-btn');
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        const sensitivityValue = document.getElementById('sensitivity-value');

        startBtn.onclick = () => {
            if (isCountingDown || isPlaying) return; 

            userStartAudio().then(() => {
                mic.start();
                startBtn.innerText = "ì¤€ë¹„ í•˜ì„¸ìš”...";
                startBtn.classList.replace('bg-red-600', 'bg-indigo-600');
                document.getElementById('mic-status').innerText = "ë§ˆì´í¬ í™œì„±";
                document.getElementById('mic-dot').classList.replace('bg-red-500', 'bg-green-500');
                
                startCountdown();
            });
        };

        sensitivitySlider.oninput = (e) => {
            sensitivity = parseFloat(e.target.value);
            sensitivityValue.innerText = sensitivity.toFixed(1);
        };

        function windowResized() {
            let w = Math.min(window.innerWidth - 40, 400);
            let h = Math.min(window.innerHeight * 0.5, 500);
            resizeCanvas(w, h);
        }
    </script>
</body>
</html>
